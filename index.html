<html>
<head>
	<link type="text/css" href="css/styles.css" rel="stylesheet" />
	<!-- <link type="text/css" href="css/custom-theme/jquery-ui-1.8.16.custom.css" rel="stylesheet" /> -->
	<script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
	<script type="text/javascript" src="js/cometd.js"></script>
	<script type="text/javascript" src="js/jquery.cometd.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.json-2.2.js"></script>
	<script type="text/javascript" src="js/jquery.jsonp-2.1.4.min.js"></script>
	<script type="text/javascript" src="js/oyatelapi.js"></script>
	<script type="text/javascript" src="js/Oyatel.js"></script>
	<script type="text/javascript" src="js/jquery-blink.js"></script>
</head>
<body>
	<div class="not-authorized">
		<div class="btn-oyatel-login"><span>Connect with Oyatel</span></div>
	</div>

	<div class="authorized">
		<div class="row">
			<span class="right">
				<span id="user"></span> <button class="oyatel-logout">Logout</button>
			</span>
		</div>
		<br/>
		<div class="grid-container">
			<div class="box callsBox">
				<p>
					<span class="box-caption">Calls today:</span><br />
					<span class="left">
						<span class="box-value" id="completed" >-</span> completed
					</span>
					<span class="right">
						<span class="box-value" id="abandoned" >-</span> abandoned
					</span>
				</p>
			</div>
			<div class="box agentsBox">
				<p>
					<span class="box-caption">Support on phone:</span><br />
					<span class="left">
						<span class="box-value" id="agentsBusy" >-</span> busy
					</span>
					<span class="right">
						<span class="box-value" id="agentsOnline" >-</span> online
					</span>
				</p>
				<div id="support"></div>
			</div>
			<div class="box queueBox">
				<p>
					<span class="box-caption">Waiting:</span><br />
					<span class="box-value" id="waiting" >-</span>
				</p>
			</div>
			<div class="box infoBox">
				<p>
					<span class="box-caption">Caller info:</span><br />
					<h2><span id="cnNumber"></span>&nbsp;&nbsp;<span id="cnName"></span></h2>
					<span id="cnAddress"></span><br />
					<span id="cnZipCity"></span><br />
					<span id="cnCountry"></span>
				</p>
			</div>
		</div>
		<br />
		<div>
			Call log:
			<div id="calls"></div>
		</div>

<script type="text/javascript">
const support = new Map();
//IE11 doesn't support Map(iterable), so setting it like this...
support.set(21102,"Adam");
support.set(3215 ,"Alexander");
support.set(2944 ,"Andreas");
support.set(20714,"Eirik");
support.set(16517,"Fredrik");
support.set(20321,"Guro");
support.set(19608,"Hanne");
support.set(3208 ,"Henrik");
support.set(2947 ,"Iselin");
support.set(21101,"Jeroen");
support.set(5546 ,"Joakim ");
support.set(2943 ,"Kjerstin");
support.set(21100,"Konrad");
support.set(16518,"Petter");
support.set(2945 ,"Silje");
support.set(4958 ,"Sonja");
support.set(3184 ,"Terje");
support.set(17333,"Truls");

function statusUpdate(id, state){
	if (support.has(id)) {
		if (state =='UNAVAILABLE'){
			if($("#" + id).length != 0) {
				$('#s' + id).remove;
			}
		}
		else {
			if($("#" + id).length == 0) {
				//it doesn't exist yet
				$('#support').append("<span id='" + id + "' class='label OTHER'>" + support.get(id) + "</span>");
			}
			else
			{ 	//update existing
				if (!$('#' + id).hasClass(state)){ //else ignore
					$('#' + id).removeClass("BUSY AVAILABLE OTHER RINGING");
					$('#' + id).addClass(state);
				} 
			}
		}	
	}
};

$(document).ready(function() {

	Oyatel.init('5C974191-C1BA-4A46-AA3C-047A86202E7E', 'https://jeroenschevernels.netlify.com/oauth_cb.html');
	
	Oyatel.bind('authorized', function() {
		authorized();
	});
	Oyatel.bind('authorizationfailed', function(errormsg) {
		console.log('The user rejected the authorization, or some error occured: ' + errormsg);
	});
	Oyatel.bind('deauthorized', function() {
		console.log('onDeauthorized callback called');
		deauthorized();
	});
	Oyatel.checkAuthorization();


	function authorized() {
		
		$('.authorized').css('display', 'block');
		$('.not-authorized').css('display', 'none');
			
		Oyatel.Events.subscribe('/events/presence', function(msg) {

			if (msg.data.event == "fulldump") {
				for (let event in msg.data.events) {
					statusUpdate(msg.data.events[event].userId, msg.data.events[event].state);
				}
			}
			else
			{
				statusUpdate(msg.data.userId, msg.data.state);
			}
		});
		
		Oyatel.User.currentUser(function(user) {
			$('#user').html(user.username + ' (' + user.firstname + ' ' + user.lastname + ')');
		});
			
		Oyatel.Events.subscribe('/events/queue', function(msg) {

			if (msg.data.queueId == "que0110312"){ 		//Filter on Support NO queue only!
				let agentsBusy = msg.data.agentsBusy;
				let agentsOnline = msg.data.agentsOnline;
				let callsAbandoned = msg.data.callsAbandoned;
				let callsCompleted = msg.data.callsCompleted;
				let callsWaiting = msg.data.callsWaiting;
				$('#waiting').html(callsWaiting);
				$('#completed').html(callsCompleted);
				$('#abandoned').html(callsAbandoned);
				$('#agentsOnline').html(agentsOnline);
				$('#agentsBusy').html(agentsBusy);
				let percentage = Math.round(callsCompleted / (callsCompleted + callsAbandoned) * 100);
				$(".callsBox").css("background-image", "linear-gradient(to right, #a2f282 " + (percentage - 5) + "% ," + percentage + "% ,#ef5d4c " + (percentage + 5) + "% )");
				$(".agentsBox").css("background","RGBA(255,0,0," + (agentsBusy / agentsOnline) + ")");
				$(".queueBox").css("background","RGBA(255,0,0," + (callsWaiting * 0.20) + ")");
			}
		});
			
		Oyatel.User.currentUser(function(msg) {
			//console.log('Oyatel.User.currentUser :', msg);
		});
		
		Oyatel.Events.subscribe('/events/call', function(msg) {
			// console.log(msg.data);
			if (support.has(msg.data.userId)) {
	            // if (msg.data.callback_ref_id && msg.data.callback_ref_id != "")
	            //     return;
	            if (msg.data.direction == "out") {
	                $('#calls').append("<p>SOMEONE CALLED OUT! IS THIS SHIT FINALLY WORKING?</p>");
	            } 
	            if (msg.data.direction === 'in') {
	            	var info = {
	                            'Name': '',
	                            'Address': '',
	                            'Zipcode': '',
	                            'City': '',
	                            'Country': ''
	                        };
	                Oyatel.Call.numberInfo(msg.data.callerId.number, function(data) {
                        if (data.matches.length > 0) {
                            if (data.matches[0].name != null) info.Name = data.matches[0].name;
                            if (data.matches[0].address != null) info.Address = data.matches[0].address;
                            if (data.matches[0].zipcode != null) info.Zipcode = data.matches[0].zipcode;
                            if (data.matches[0].city != null) info.City = data.matches[0].city;
                        }
                        if (data.location != null) info.Country = data.location;
                        if (msg.data.event == 'ring') {
	                        $('#cnNumber').html(msg.data.callerId.number);
	                        $('#cnName').html(info.Name);
	                        $('#cnAddress').html(info.Address);
	                        $('#cnZipCity').html(info.Zipcode + " " + info.City);
	                        $('#cnCountry').html(info.Country);    
		                }
		                else if (msg.data.event == 'hangup') {
		                    let string = support.get(msg.data.userId) +": "
		                    if (info.Name != ""){
		                    	string += info.Name + " (" + msg.data.callerId.number + ")"
		                    }
		                    else {
		                    	string += msg.data.callerId.number
		                    }	                     
		                    $('#calls').append("<span class='log'>" + string + "</span>&nbsp;");
		                }
		                else {
		                	console.log('other status!!!');
		                	console.log(msg.data);
		                }
                    });
	                

	            }
	        }
        });
	}

	function deauthorized() {
		$('#connect .authorized').css('display', 'none');
		$('#connect .not-authorized').css('display', 'block');
	}
	
	$('.btn-oyatel-login').click(function() {
		Oyatel.authorize();
	});
	$('.oyatel-logout').click(function() {
		Oyatel.deauthorize();
	});	
});

</script>
</div>
</body>
</html>